# Rule Editor - WXDB検出ルール作成ツール

WIXOSS Trading Card Gameのカードテキストから特徴を検出するための正規表現パターンを作成・管理するツールです。

## 概要

rule_editorは以下の機能を提供します：

- キーワードベースでのwix_rawcardテーブル検索
- 文単位での分類（マッチすべき/マッチすべきでない/無関係）
- OpenAI APIを使用した正規表現パターンの自動生成
- パターンの保存・管理
- 保存されたパターンをRustコード形式でエクスポート

## 前提条件

### 必須
- Rust 1.70+
- PostgreSQL データベース（既存のwixdbを使用）
- Python 3.12+（Django環境）

### オプション（フル機能を使用する場合）
- OpenAI API キー
- システムライブラリ（GUI機能用）:
  ```bash
  sudo apt install -y libgtk-3-dev libcairo2-dev libgdk-pixbuf2.0-dev \
    libglib2.0-dev libgobject-introspection-1.0-dev libpango1.0-dev \
    libatk1.0-dev libsoup-3.0-dev libjavascriptcoregtk-4.1-dev \
    libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev \
    libayatana-appindicator3-dev librsvg2-dev
  ```

## セットアップ手順

### 1. データベースマイグレーション

rule_patternテーブルを作成します：

```bash
# プロジェクトルートから実行
cd table_definition
source .venv/bin/activate  # または .venv/bin/python を直接使用
python manage.py migrate
```

### 2. 環境変数設定

`.env`ファイルにOpenAI API設定を追加（オプション）：

```bash
# .env ファイルに追加
OPENAI_API_KEY=sk-your-openai-api-key-here
OPENAI_MODEL=gpt-4o-mini
```

### 3. 依存関係のインストール

```bash
# プロジェクトルートから実行
cargo build -p rule_editor
```

## 使用方法

### CLIモード（現在利用可能）

#### 基本的な使用方法

```bash
# ヘルプメッセージを表示
cargo run -p rule_editor

# パターンをエクスポート
cargo run -p rule_editor export
```

#### Makefileタスク

```bash
# パターンエクスポート
cargo make export_patterns
```

### パターンの管理

#### 1. テストパターンの作成

Djangoシェルを使用してテストデータを作成：

```bash
cd table_definition
.venv/bin/python manage.py shell -c "
from wix.models import RulePattern

# 例：トラッシュ回収パターン
pattern = RulePattern.objects.create(
    keyword='手札に加える',
    pattern=r'手札に加え',
    features=['Salvage'],
    positive_examples=['あなたのトラッシュからシグニ1枚を対象とし、それを手札に加える。'],
    negative_examples=['対戦相手は手札を1枚捨てる。']
)
print(f'Created pattern with ID: {pattern.id}')
"
```

#### 2. パターンの確認

```bash
cd table_definition
.venv/bin/python manage.py shell -c "
from wix.models import RulePattern
patterns = RulePattern.objects.all()
for p in patterns:
    print(f'ID: {p.id}, Keyword: {p.keyword}, Pattern: {p.pattern}')
"
```

#### 3. パターンのエクスポート

```bash
# プロジェクトルートから実行
cargo run -p rule_editor export

# 生成されたファイルを確認
cat shared/feature/src/generated_patterns.rs
```

## 出力ファイル

エクスポート機能により、以下のファイルが生成されます：

- **出力先**: `shared/feature/src/generated_patterns.rs`
- **形式**: `detect_pattern!`マクロを使用したRustコード

### 生成例

```rust
// Auto-generated by rule_editor
// このファイルは自動生成されています。直接編集しないでください。

detect_pattern![r"手札に加え", CardFeature::Salvage], // 手札に加える
detect_pattern![r"バニッシュ", CardFeature::Banish], // バニッシュ
```

## データベーススキーマ

### wix_rule_pattern テーブル

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | SERIAL PRIMARY KEY | 主キー |
| keyword | VARCHAR(256) | 検索キーワード |
| pattern | VARCHAR(512) | 正規表現パターン |
| features | JSONB | 検出するCardFeatureの配列 |
| positive_examples | JSONB | マッチすべき例文の配列 |
| negative_examples | JSONB | マッチすべきでない例文の配列 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |
| is_active | BOOLEAN | 有効フラグ |

## 開発とデバッグ

### ログ出力

```bash
# 詳細なログ出力
RUST_LOG=debug cargo run -p rule_editor export
```

### データベース接続の確認

```bash
# PostgreSQLへの接続テスト
psql -h 192.168.56.10 -U wix -d wixdb -c "SELECT COUNT(*) FROM wix_rule_pattern;"
```

### コンパイルエラーの解決

```bash
# 依存関係のチェック
cargo check -p rule_editor

# クリーンビルド
cargo clean && cargo build -p rule_editor
```

## 将来の機能（GUI）

システム依存関係がインストールされた環境では、以下の機能が利用可能になります：

### Tauri GUIアプリケーション

```bash
# フロントエンド依存関係のインストール
cargo make rule_editor_deps

# 開発サーバーの起動
cargo make rule_editor

# プロダクションビルド
cargo make rule_editor_build
```

### 主要機能

1. **キーワード検索**: wix_rawcardテーブルからの検索
2. **文分割表示**: skill_textを句点で分割して表示
3. **分類UI**: 文ごとの分類（マッチすべき/すべきでない/無関係）
4. **AI生成**: OpenAI APIによる正規表現パターンの自動生成
5. **プレビュー**: 生成されたパターンの確認
6. **保存**: データベースへの保存
7. **エクスポート**: Rustコード形式での出力

## トラブルシューティング

### よくある問題

#### 1. データベース接続エラー

```bash
# 接続設定の確認
echo $DB_HOST $DB_PORT $DB_USER $DB_NAME
```

#### 2. マイグレーションエラー

```bash
# マイグレーション状態の確認
cd table_definition
.venv/bin/python manage.py showmigrations wix

# 必要に応じてマイグレーションをリセット
.venv/bin/python manage.py migrate wix 0018 --fake
.venv/bin/python manage.py migrate
```

#### 3. 型エラー（JSONB vs TEXT[]）

データベースとRustの型定義が一致しない場合：

```bash
# テーブルの再作成
cd table_definition
.venv/bin/python manage.py shell -c "
from django.db import connection
cursor = connection.cursor()
cursor.execute('DROP TABLE IF EXISTS wix_rule_pattern CASCADE;')
"
.venv/bin/python manage.py migrate
```

## 関連ファイル

- **設定**: `Cargo.toml`, `src-tauri/tauri.conf.json`
- **バックエンド**: `src/main.rs`, `src/commands/`, `src/models/`
- **フロントエンド**: `ui/` ディレクトリ（Nuxt 3プロジェクト）
- **マイグレーション**: `table_definition/wix/migrations/0019_create_rule_pattern_table.py`
- **出力**: `shared/feature/src/generated_patterns.rs`

## ライセンス

このプロジェクトの一部として、親プロジェクトのライセンスに従います。