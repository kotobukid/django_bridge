# Analyzer Crate - AI Assistant Guide

## 重要: 記号保持とテキスト処理

### ⚠️ 絶対に保持すべき記号
analyzerクレートは、scraperが抽出したテキストを処理してCardFeatureを検出します。
以下の記号は**絶対に削除してはいけません**：

- `【】` brackets: 能力検出に使用（`【アサシン】`, `【チャーム】`, `【ライフバースト】`など）
- `《》` brackets: ゲームメカニック検出に使用（`《ガードアイコン》`, `《クラフト》`など）
- `:` colons: タイミング検出に使用（`出：`, `自：`, `起：`など）

### 処理フロー
1. **Scraper** (`scraper/src/raw_card.rs`):
   - `replace_img_tags_with_alt()`: IMGタグをalt属性のテキストに置換
   - **重要**: alt属性内の記号（`【】`, `《》`）は保持される

2. **Analyzer** (`analyzer/src/raw_card_analyzer.rs`):
   - `to_half()`: 全角英数字を半角に変換
   - **重要**: 日本語の記号（`【】`, `《》`）はそのまま保持される

3. **Feature Detection** (`shared/feature/src/lib.rs`):
   - 正規表現パターンで記号を含むテキストを検出
   - 記号が削除されていると検出が失敗する

### 過去の問題と教訓
- **問題**: 以前、「クリーンなテキスト」を作るために記号を削除していた
- **結果**: 
  - 緑色のカードが0件として表示される
  - アサシン、ガード、チャームなどの能力が検出されない
  - タイミング指示子（`出：`, `自：`）が消失
- **解決**: 記号を保持することで正確な検出が可能になった（2025-01-10）

### デバッグ時の確認事項
CardFeature検出が期待通りに動作しない場合：
1. RawCardテーブルのskill_textとlife_burst_textに記号が含まれているか確認
2. `to_half()`関数が記号を保持しているか確認
3. feature検出パターンが正しい記号を検索しているか確認

### テスト時の注意
統合テストを作成する際は、必ず記号を含むカードでテストすること：
- `【】`を含む能力（例：`【アサシン】`）
- `《》`を含むアイコン（例：`《ガードアイコン》`）
- `：`を含むタイミング（例：`出：`）